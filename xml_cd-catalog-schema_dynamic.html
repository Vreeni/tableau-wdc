<html>
<head>
<title>XML Connector</title>
    <meta http-equiv="Cache-Control" content="no-store" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>    
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>   
    <script type="text/javascript">
 
(function() {
    // Create the connector object
    var myConnector = tableau.makeConnector();
	
    // Define the schema (right now is hardcoded > get dynamically?)
    myConnector.getSchema = function(schemaCallback) {
        _retrieveXmlData(function (tableData) {
        var headers = tableData.headers;
	var cols = [];   
        for (var fieldName in headers) {
            if (headers.hasOwnProperty(fieldName)) {
		var singleCol = {
			id: fieldName,
			dataType: headers[fieldName]
		}
		cols.push(singleCol);
             }
         }
		   
        var tableSchema = {
            id: "XML feed",
            alias: "XML feed alias",
            columns: cols
        };
	console.log(cols);
        schemaCallback([tableSchema]);
       });
    };
	
	    

	
// Get the data from default link/file ==> tbd: get data from input Url
 myConnector.getData = function(table, doneCallback) {
      _retrieveXmlData(function (tableData) {
     // var rowData = tableData.rowData;
	table.appendRows(tableData);
	doneCallback();
      });
  };
  tableau.registerConnector(myConnector);

  	
    
function _retrieveXmlData(retrieveDataCallback) {
  if (!window.cachedTableData) {
    var conData = JSON.parse(tableau.connectionData);
    var xmlString = conData.xmlString;
    if (conData.xmlUrl) {
	const proxyurl = "https://cors-anywhere.herokuapp.com/";
        var xhttp = new XMLHttpRequest();
    	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var xmlDoc = this.responseXML;
			window.cachedTableData = _xmlToTable(xmlDoc);
			retrieveDataCallback(window.cachedTableData);
          	 }
	};
	//enter pre-defined url or take it from user input, but then have to figure out how to dynamically get the schema (right now is hardcoded)
        xhttp.open('GET', proxyurl + 'https://www.w3schools.com/xml/cd_catalog.xml', true);
	xhttp.send();
	    
      /*var successCallback = function(data) {
        window.cachedTableData = _xmlToTable(data);
        retrieveDataCallback(window.cachedTableData);
      };
      _xmlHttpReq(conData.xmlUrl, successCallback);*/
      return;
    }
    try {
      var xmlDoc = $.parseXML(conData.xmlString);
      window.cachedTableData = _xmlToTable(xmlDoc);
    }
    catch (e) {
      tableau.abortWithError("unable to parse xml data");
      return;
    }
  }
  retrieveDataCallback(window.cachedTableData);
}
	    
	
	    
function _xmlHttpReq(url, successCallback) {   
       	const proxyurl = "https://cors-anywhere.herokuapp.com/";
        var xhttp = new XMLHttpRequest();
    	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			var xmlDoc = this.responseXML;
       			console.log("xmlhttpreq success" + xmlDoc.length);
			successCallback;
          	 }
	};
	//enter pre-defined url or take it from user input, but then have to figure out how to dynamically get the schema (right now is hardcoded)
        xhttp.open('GET', proxyurl + 'https://www.w3schools.com/xml/cd_catalog.xml', true);
	xhttp.send();
    }
    
	  
 


	

function _submitXMLToTableau(xmlString, xmlUrl) {
    console.log("submitting xml to tableau");
    var conData = {"xmlString" : xmlString, "xmlUrl": xmlUrl};
    tableau.connectionName = "XML data: "; // This will be the data source name in Tableau
    tableau.connectionData = JSON.stringify(conData);
    tableau.submit();  
}

    /*
    // Create event listeners for when the user submits the input url or wants to use default test data
    $(document).ready(function() {
        $("#submitText").click(function() {
	    console.log("Button submitText clicked");
	    var dataId = document.getElementById("inputText");
            tableau.connectionName = "Test Data: Using default test data"; // This will be the data source name in Tableau
            tableau.connectionData = dataId;
	    tableau.submit(); // This sends the connector object to Tableau
        });
    });
    */
    

	    
    
    $(document).ready(function() {
        $("#submitUrl").click(function() {
	   console.log("Button submitUrl clicked");
	   var xmlString = document.getElementById("inputURL");
           var xmlUrl = document.getElementById("inputText");
	  // _submitXMLToTableau(xmlString, xmlUrl);
		var conData = {"xmlString" : xmlString, "xmlUrl": xmlUrl};
    tableau.connectionName = "XML data: "; // This will be the data source name in Tableau
    tableau.connectionData = JSON.stringify(conData);
    tableau.submit(); 
	   
        });
    });
         
   })();
  </script>

</head>


<body>

 <div class="container container-table">
        <div class="row vertical-center-row">
           <div class="text-center col-md-4 col-md-offset-4">

<p id = "descriptionUrl">Enter URL to XML file</p>
<input id="inputURL" >
<button type = "button" id = "submitUrl" class = "btn btn-success" style = "margin: 10px;">Submit URL</button>
  <br>
<p id = "descriptionText">Paste XML file</p>
<textarea id="inputText" rows="10" cols="70"></textarea>
<button type = "button" id = "submitText" class = "btn btn-success" style = "margin: 10px;">Submit file</button>
  </div>
 </div>
</div>

</body>	
</html>
