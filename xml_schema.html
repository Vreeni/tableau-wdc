<html>
<head>
<title>XML Connector</title>
    <meta http-equiv="Cache-Control" content="no-store" />
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>    
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>   
    <script type="text/javascript">
 
(function() {
    // Create the connector object
    var myConnector = tableau.makeConnector();
    // Define the schema
    myConnector.getSchema = function(schemaCallback) {
        var cols = [{
            id: "col1",
            alias: "col1_alias",
            dataType: tableau.dataTypeEnum.string
	}, {
            id: "col2",
            alias: "col2_alias",
            dataType: tableau.dataTypeEnum.string
        }];
        var tableSchema = {
            id: "Test_feed",
            alias: "Test feed",
            columns: cols
        };
        schemaCallback([tableSchema]);
    };
	
// Get the data from default link/file ==> tbd: get data from input Url
 myConnector.getData = function(table, doneCallback) {
      const proxyurl = "http://cors-anywhere.herokuapp.com/";
      var xhttp = new XMLHttpRequest();
    	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			//myFunction(this);
			var xmlDoc = this.responseXML;
 			var tableCD = xmlDoc.getElementsByTagName("CD");
  			tableData = [];
  			for (i = 0; i < tableCD.length; i++) { 
        			tableData.push({
               				"id": tableCD[i].getElementsByTagName("TITLE")[0].childNodes[0].nodeValue,
               				"artist": tableCD[i].getElementsByTagName("ARTIST")[0].childNodes[0].nodeValue
       				});
  			}
  			table.appendRows(tableData);
		        doneCallback();
          	 }
	};
	
        xhttp.open('GET', proxyurl + 'http://sapdsma2.sap.infineon.com:8007/sap/bc/srt/wsdl/flv_10002P111AD1/sdef_url/ZBC_P2OPS_READ_DATA?sap-client=100', true);
	xhttp.send();
	};
      tableau.registerConnector(myConnector);
      
function myFunction(xml) {
  var xmlDoc = xml.responseXML;
  var tableCD = xmlDoc.getElementsByTagName("CD");
  tableData = [];
  for (i = 0; i < tableCD.length; i++) { 
        tableData.push({
               "id": tableCD[i].getElementsByTagName("TITLE")[0].childNodes[0].nodeValue,
               "artist": tableCD[i].getElementsByTagName("ARTIST")[0].childNodes[0].nodeValue
        });
  }
  table.appendRows(tableData);
}

	  /*  
    $.getJSON("https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_week.geojson", function(resp) {
            var feat = resp.features; //"features" hereby representing the name of a JSONArray within the JSONObject
                tableData = [];
            // Iterate over the JSON object
	  for (var i = 0, len = feat.length; i < len; i++) {
                tableData.push({
                    "id": feat[i].id,
		    "test": feat[i].mag
                });
            }
            table.appendRows(tableData);
            doneCallback();
        });
    };
    tableau.registerConnector(myConnector);





(function() {
  var myConnector = tableau.makeConnector();
  myConnector.init = function () {
    tableau.connectionName = 'XML data';
    tableau.initCallback();
  };
  myConnector.getSchema = function() {
    _retrieveXmlData(function (tableData) {
      var headers = tableData.headers;
      var fieldNames = [];
      var fieldTypes = [];
      for (var fieldName in headers) {
        if (headers.hasOwnProperty(fieldName)) {
          fieldNames.push(fieldName);
          fieldTypes.push(headers[fieldName]);
        }
      }
      tableau.headersCallback(fieldNames, fieldTypes); // tell tableau about the fields and their types
    });
  }
      
  myConnector.getTableData = function (lastRecordToken) {
    _retrieveXmlData(function (tableData) {
      var rowData = tableData.rowData;
      tableau.dataCallback(rowData, rowData.length.toString(), false);
    });
  };
  tableau.registerConnector(myConnector);
})();

//replace this function with a function solely trying to get xmlString from a URL ?
function _retrieveXmlData(retrieveDataCallback) {
  if (!window.cachedTableData) {
    var conData = JSON.parse(tableau.connectionData);
    var xmlString = conData.xmlString;
    if (conData.xmlUrl) {
      var successCallback = function(data) {
        window.cachedTableData = _xmlToTable(data);
        retrieveDataCallback(window.cachedTableData);
      };
      //_basicAjaxRequest1(conData.xmlUrl, successCallback);
      //here try another approach not using yql but xmlHttpRequest?
      //try xml dom to get url (xml http request)
	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
		myFunction(this);
		}
	};
	xhttp.open('GET', 'https://www.w3schools.com/xml/cd_catalog.xml', true);
	xhttp.send();
	    
      return;
    }
    try {
      var xmlDoc = $.parseXML(conData.xmlString);
      window.cachedTableData = _xmlToTable(xmlDoc);
    }
    catch (e) {
      tableau.abortWithError("unable to parse xml data");
      return;
    }
  }
 retrieveDataCallback(window.cachedTableData);
}

	
function myFunction(xml) {	
  var xmlDoc = xml.responseXML;
  window.cachedTableData = _xmlToTable(xmlDoc);
  
  var x, i, xmlDoc, table;
  xmlDoc = xml.responseXML;
  table = "<tr><th>Artist</th><th>Title</th></tr>";
  x = xmlDoc.getElementsByTagName("CD")
  for (i = 0; i < x.length; i++) { 
    table += "<tr><td>" + 
    x[i].getElementsByTagName("ARTIST")[0].childNodes[0].nodeValue +
    "</td><td>" +
    x[i].getElementsByTagName("TITLE")[0].childNodes[0].nodeValue +
    "</td></tr>";
  }
  document.getElementById("demo").innerHTML = table;
  
}
	

// There are a lot of ways to handle URLS. Sometimes we'll need workarounds for CORS. These
// methods chain together a series of attempts to get the data at the given url
function _ajaxRequestHelper(url, successCallback, conUrl, nextFunction, specialSuccessCallback){
  specialSuccessCallback = specialSuccessCallback || successCallback;
  var xhr = $.ajax({ 
    url: conUrl, 
    dataType: 'xml', 
    success: specialSuccessCallback,
    error: function()
    {
      nextFunction(url, successCallback);
    }
  });
}
// try the straightforward request
function _basicAjaxRequest1(url, successCallback){
  _ajaxRequestHelper(url, successCallback, url, _yqlProxyAjaxRequest2);
}
// try to use yql as a proxy
function _yqlProxyAjaxRequest2(url, successCallback){
  var yqlQueryBase = "http://query.yahooapis.com/v1/public/yql?q=";
  var query = "select * from htmlstring where url='" + url + "'";
  var restOfQueryString = "&format=xml" ;
  var yqlUrl = yqlQueryBase + encodeURIComponent(query) + restOfQueryString + "&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys";
  _ajaxRequestHelper(url, successCallback, yqlUrl, _giveUpOnUrl9);
}
function _giveUpOnUrl9(url, successCallback) {
  tableau.abortWithError("Could not load url: " + url);
}
// Takes a hierarchical xml document and tries to turn it into a table
// Returns an object with headers and the row level data
function _xmlToTable(xmlDocument) {
  var rowData = _flattenData(xmlDocument);
  var headers = _extractHeaders(rowData);
  return {"headers":headers, "rowData":rowData};
}
// Given an object:
//   - finds the longest array in the xml
//   - flattens each element in that array so it is a single element with many properties
// If there is no array that is a descendent of the original object, this wraps
function _flattenData(xmlDocument) {
  // first find the longest array
  var longestArray = _findLongestArray(xmlDocument, xmlDocument);
  if (!longestArray || longestArray.length == 0) {
    // if no array found, just wrap the entire object blob in an array
    longestArray = [objectBlob];
  }
  toRet = [];
  for (var ii = 0; ii < longestArray.childNodes.length; ++ii) {
    toRet[ii] = _flattenObject(longestArray.childNodes[ii]);
  }
  return toRet;
}
// Given an element with hierarchical properties, flattens it so all the properties
// sit on the base element.
function _flattenObject(xmlElt) {
  var toRet = {};
  if (xmlElt.attributes)
  {
    for (var attributeNum = 0; attributeNum < xmlElt.attributes.length; ++attributeNum) {
      var attribute = xmlElt.attributes[attributeNum];
      toRet[attribute.nodeName] = attribute.nodeValue;
    }
  }
  
  var children = xmlElt.childNodes;
  if (!children || !children.length) {
    if (xmlElt.textContent) {
      toRet.text = xmlElt.textContent.trim();
    }
  } else {  
  	for (var childNum = 0; childNum < children.length; ++childNum) {
  	  var child = xmlElt.childNodes[childNum];
  	  var childName = child.nodeName;
  	  var subObj = _flattenObject(child);
  	  for (var k in subObj) {
  	    if (subObj.hasOwnProperty(k)) {
  		    toRet[childName + '_' + k] = subObj[k];
  	    }
    	}
  	}
  }
  return toRet;
}
// Finds the longest array that is a descendent of the given object
function _findLongestArray(xmlElement, bestSoFar) {
  var children = xmlElement.childNodes;
  if (children && children.length) {
    if (children.length > bestSoFar.childNodes.length) {
      bestSoFar = xmlElement;
    }
    for (var childNum in children) {
      var subBest = _findLongestArray(children[childNum], bestSoFar);
      if (subBest.childNodes.length > bestSoFar.childNodes.length) {
        bestSoFar = subBest;
      }
    }
  }
  return bestSoFar;
}
// Given an array of js objects, returns a map from data column name to data type
function _extractHeaders(rowData) {
  var toRet = {};
  for (var row = 0; row < rowData.length; ++row) {
    var rowLine = rowData[row];
    for (var key in rowLine) {
      if (rowLine.hasOwnProperty(key)) {
        if (!(key in toRet)) {
          toRet[key] = _determineType(rowLine[key]);
        }
      }
    }
  }
  return toRet;
}
// Given a primitive, tries to make a guess at the data type of the input
function _determineType(primitive) {
  // possible types: 'float', 'date', 'datetime', 'bool', 'string', 'int'
  if (parseInt(primitive) == primitive) return 'int';
  if (parseFloat(primitive) == primitive) return 'float';
  if (isFinite(new Date(primitive).getTime())) return 'datetime';
  return 'string';
}
function _submitXMLToTableau(xmlString, xmlUrl) {
    var conData = {"xmlString" : xmlString, "xmlUrl": xmlUrl};
    tableau.connectionData = JSON.stringify(conData);
    tableau.submit();  
}
function _buildConnectionUrl(url) {
  // var yqlQueryBase = "http://query.yahooapis.com/v1/public/yql?q=";
  // var query = "select * from html where url='" + url + "'";
  // var restOfQueryString = "&format=xml";
  // var yqlUrl = yqlQueryBase + encodeURIComponent(query) + restOfQueryString;
  // return yqlUrl;
  return url;
}
$(document).ready(function(){
  var cancel = function (e) {    
      e.stopPropagation();
      e.preventDefault();
  }
  $("#inputForm").submit(function(e) { // This event fires when a button is clicked
    // Since we use a form for input, make sure to stop the default form behavior
    cancel(e);
    var xmlString = $('textarea[name=xmlText]')[0].value.trim();
    var xmlUrl = $('input[name=xmlUrl]')[0].value.trim();
    _submitXMLToTableau(xmlString, xmlUrl);
  });
  var ddHandler = $("#dragandrophandler");
  ddHandler.on('dragenter', function (e) 
  {
      cancel(e);
      $(this).css('border', '2px solid #0B85A1');
  }).on('dragover', cancel)
    .on('drop', function (e) 
  {
       $(this).css('border', '2px dashed #0B85A1');
       e.preventDefault();
       var files = e.originalEvent.dataTransfer.files;
       var file = files[0];
       var reader = new FileReader();
       reader.onload = function(e) { _submitXMLToTableau(reader.result); };
       reader.readAsText(file);
  });
  $(document).on('dragenter', cancel)
             .on('drop', cancel)
             .on('dragover', function (e) 
  {
    cancel(e);
    ddHandler.css('border', '2px dashed #0B85A1');
  });
});

<style>
#dragandrophandler {
  border:1px dashed #999;
  width:300px;
  color:#333;
  text-align:left;vertical-align:middle;
  padding:10px 10px 10 10px;
  margin:10px;
  font-size:150%;
}
</style>
</head>
<body>

<form id="inputForm" action="">
  Enter a URL for XML data: 
  <input type="text" name="xmlUrl" size="50" />  
  <br>
  <div id="dragandrophandler">Or Drag & Drop Files Here</div>
  <br>
  Or paste XML data below
  <br>
  <textarea name="xmlText" rows="10" cols="70"/></textarea>
  <input type="submit" value="Submit">
</form>

</body>
</html>

*/





    // Create event listeners for when the user submits the input url or wants to use default test data
    $(document).ready(function() {
        $("#submitButton").click(function() {
            tableau.connectionName = "Test Data: Using default test data"; // This will be the data source name in Tableau
            tableau.submit(); // This sends the connector object to Tableau
        });
    });
    $(document).ready(function() {
        $("#submitUrl").click(function() {
	   var dataId = document.getElementById("inputURL");
	   tableau.connectionName = "URL: " + dataId;
	   tableau.connectionData = dataId;
	   tableau.submit();
        });
    });
           
   })();
  </script>

</head>


<body>

 <div class="container container-table">
        <div class="row vertical-center-row">
           <div class="text-center col-md-4 col-md-offset-4">

<p id = "inputDescription">Enter URL to JSON file</p>
<input id="inputURL" >
  <!--<input type="text" name="xmlUrl" size="50"/>-->
  <!--
      <div id="dragandrophandler">Or Drag & Drop Files Here</div>
      <br>
      Or paste XML data below
      <br>
      <textarea name="xmlText" rows="10" cols="70"/></textarea>
      <br>
  -->
  
  <!--<input type="submit" value="Get Data!">-->
  <!--//submit url button--->
  <button type = "button" id = "submitUrl" class = "btn btn-success" style = "margin: 10px;">Submit</button>
  <br>
  <!--button getting data from default dataset (earthquake or p2ops file)-->
  <button type = "button" id = "submitButton" class = "btn btn-success" style = "margin: 10px;">Get Test Data</button>
  </div>
 </div>
</div>


</body>
</html>
